<div class="chart-dashboard">

  <h1>Setup Chart</h1>


  <div *ngIf="sourceData.length && !addNewSource" class="data-loaded-banner fade-in">
    <button (click)="resetOptions()"> Add New Source</button>
  </div>

  <div *ngIf="!sourceData.length || addNewSource" class="form-container slide-in">

    <h4>üì° Data Loader</h4>

    <div class="form-group">
      <label> <mat-icon class="file-icon">insert_drive_file</mat-icon> Source Name:</label>
      <input type="text" [(ngModel)]="sourceName" [disabled]="selectedChartFiles" placeholder="Enter Source Name" />
      <div *ngIf="showErrors && !sourceName" class="error-text">
        ‚ö†Ô∏è Source Name is required
      </div>
      <div *ngIf="showErrors && sourceName && sourceName.length > 30" class="error-text">
        ‚ö†Ô∏è Source Name cannot exceed 32 characters
      </div>
    </div>

    <div class="form-group">
      <label for="sourceTypeSelect">
        <mat-icon class="file-icon">link</mat-icon>Source Type:
      </label>
      <div class="input-wrapper">
        <select id="sourceTypeSelect" [(ngModel)]="sourceType" (change)="changeSourceType()">
          <option [ngValue]="1">Load From API</option>
          <option [ngValue]="2">Load From Excel</option>
        </select>
      </div>
    </div>

    @if (sourceType == 1) {
    <div class="form-group">
      <label><span class="icon">üîó</span> Load from API:</label>
      <input type="text" [(ngModel)]="apiUrl" placeholder="Enter API URL or path" />
    </div>
    }
    @if (sourceType == 2) {
    <div class="form-group">

      <!-- @if (showSheetSelector) {
      <div *ngIf="showSheetSelector" class="sheet-select-box">
        <label>Select Sheet:</label>
        <select [(ngModel)]="selectedSheet" (change)="loadSelectedSheet(tempWorkbook, selectedSheet)">
          <option value="">none</option>
          <option *ngFor="let sheet of sheetNames" [value]="sheet">{{ sheet }}</option>
        </select>
      </div>
      } @else { -->
      <div class="file-upload-box" (click)="fileInput.click()" [class.uploaded]="uploadedFileName">
        <div *ngIf="uploadedFileName" class="uploaded-file-icon">
          <div class="file-icon-container">
            <span class="material-icons file-icon">
              cloud_done
            </span>
          </div>
          <div class="file-info">
            <span class="file-name">{{ uploadedFileName }}</span>
            <span class="material-icons remove-btn" (click)="$event.stopPropagation(); removeFile()">
              close
            </span>
          </div>
        </div>

        <div *ngIf="!uploadedFileName" class="empty-state-design">
          <div class="upload-icon-container">
            <span class="material-icons upload-icon">
              cloud_upload
            </span>
          </div>
          <p class="upload-text">Upload Excel Document</p>
          <p class="recommended-size">Recommended size 5MB</p>
        </div>
        <input type="file" #fileInput (change)="onFileChange($event)" accept=".xlsx, .xls, .csv" style="display: none;">
      </div>
      <!-- } -->

    </div>
    }

    <div *ngIf="showErrors && !apiUrl && !uploadedExcelData" class="error-text">
      ‚ö†Ô∏è Please enter an API URL or upload an Excel file
    </div>

    <div class="button-group">
      <button (click)="fetchData()" [disabled]="isLoading">
        @if(!isLoading){
        <span>üîÑ Fetch Data</span>
        }@else {
        <span>‚è≥ Loading...</span>
        }
      </button>
      <button (click)="backToConfigChart()" [disabled]="isLoading">
        <span> Back</span>
      </button>
      <button (click)="onCancel()">
        <span> Cancel</span>
      </button>
    </div>
  </div>

  <!-- Always show chart button -->
  @if (sourceData.length && !addNewSource) {
  <div class="layout fade-in">
    <aside class="sidebar slide-in">
      <div class="sidebar-section">
        <div class="input-with-suffix">
          <input type="text" [(ngModel)]="title" placeholder="Enter Chart Title" />
          <button class="suffix-btn align-trigger" type="button" (click)="toggleTitleAlignMenu($event)"
            [attr.aria-expanded]="isTitleAlignOpen">
            <i class="material-icons">
              {{ titleAlign === 'left' ? 'format_align_left' : (titleAlign === 'center' ? 'format_align_center' :
              'format_align_right') }}
            </i>
          </button>

          <div class="align-popover" *ngIf="isTitleAlignOpen" (click)="$event.stopPropagation()">
            <button class="align-option" [class.active]="titleAlign==='left'" (click)="setTitleAlign('left')"
              type="button">
              <i class="material-icons">format_align_left</i>
            </button>
            <button class="align-option" [class.active]="titleAlign==='center'" (click)="setTitleAlign('center')"
              type="button">
              <i class="material-icons">format_align_center</i>
            </button>
            <button class="align-option" [class.active]="titleAlign==='right'" (click)="setTitleAlign('right')"
              type="button">
              <i class="material-icons">format_align_right</i>
            </button>
          </div>
        </div>
        <div class="input-with-suffix">
          <input type="text" [(ngModel)]="subTitle" placeholder="Enter Chart Subtitle" />
          <button class="suffix-btn align-trigger" type="button" (click)="toggleSubTitleAlignMenu($event)"
            [attr.aria-expanded]="isSubTitleAlignOpen">
            <i class="material-icons">
              {{ subTitleAlign === 'left' ? 'format_align_left' : (subTitleAlign === 'center' ? 'format_align_center' :
              'format_align_right') }}
            </i>
          </button>

          <div class="align-popover" *ngIf="isSubTitleAlignOpen" (click)="$event.stopPropagation()">
            <button class="align-option" [class.active]="subTitleAlign==='left'" (click)="setSubTitleAlign('left')"
              type="button">
              <i class="material-icons">format_align_left</i>
            </button>
            <button class="align-option" [class.active]="subTitleAlign==='center'" (click)="setSubTitleAlign('center')"
              type="button">
              <i class="material-icons">format_align_center</i>
            </button>
            <button class="align-option" [class.active]="subTitleAlign==='right'" (click)="setSubTitleAlign('right')"
              type="button">
              <i class="material-icons">format_align_right</i>
            </button>
          </div>
        </div>
      </div>

      <div class="sidebar-section">

        <label>Data Source</label>
        <select [(ngModel)]="rawData" (change)="changeSource()">
          <option *ngFor="let f of sourceData" [ngValue]="f.name">{{ f.name }}</option>
        </select>

        <label>Chart Caterory</label>
        <select [(ngModel)]="selectedChartCate" (change)="changeCategory()" [compareWith]="compareObjectsByKey('id')">
          <option *ngFor="let f of chartCategories" [ngValue]="f">{{ f.name }}</option>
        </select>
      </div>

      <ng-container *ngIf="selectedChartCate?.id == 4">
        <div class="sidebar-section" *ngIf="selectedChartCate?.xAxis">
          <label>X-Axis</label>
          <select [(ngModel)]="selectedXAxis">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartCate?.zooming">
          <label>Zooming</label>
          <select [(ngModel)]="zooming">
            <option value="">none</option>
            <option value="x">x-axis</option>
            <option value="y">y-axis</option>
            <option value="xy">xy-axis</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartCate?.showLegend">
          <label><input type="checkbox" [(ngModel)]="showLengend" /> Show Lengend</label>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartCate?.dataLabel">
          <label><input type="checkbox" [(ngModel)]="dataLabel" /> Show Data Labels</label>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartCate?.enableMouseTracking">
          <label><input type="checkbox" [(ngModel)]="enableMouseTracking" /> Enable
            Mouse Tracking</label>
        </div>

        <div *ngFor="let axis of yAxes; let i = index" class="sidebar-section">
          <label>Y-Axis Title:</label>
          <input type="text" [(ngModel)]="axis.title" placeholder="Enter Y-Axis Title" />

          <label>Unit:</label>
          <input type="text" [(ngModel)]="axis.unit" placeholder="Enter Unit" />


          <div class="theme-color-field">
            <label for="themeColorInput">
              Theme color <span class="required">(i.e. #ffffff)<sup>*</sup></span>
            </label>

            <div class="theme-color-input-group">
              <input type="text" id="themeColorInput" [(ngModel)]="axis.color" placeholder="#ffffff"
                class="theme-color-text" />
              <input type="color" [(ngModel)]="axis.color" class="theme-color-picker" />
            </div>
          </div>

          <div class="sidebar-section">
            <label><input type="checkbox" [(ngModel)]="axis.opposite" /> opposite </label>
          </div>

          <div class="sidebar-section">
            <label>Chart Option</label>
            <select [(ngModel)]="axis.chartType">
              <option value="">none</option>
              <option value="column">Column</option>
              <option value="spline">Spline</option>
              <option value="line">line</option>
              <option value="area">area</option>
            </select>
          </div>

          <label>Select Series Field:</label>
          <select [(ngModel)]="axis.field">
            <option *ngFor="let key of allFields" [value]="key">{{ key }}</option>
          </select>

          <button (click)="removeYAxis(i)">‚ùå Remove</button>
        </div>
        <button (click)="addYAxis()">‚ûï Add Y-Axis</button>

      </ng-container>


      <ng-container
        *ngIf="selectedChartCate?.id == 1 || selectedChartCate?.id == 2 || selectedChartCate?.id == 3 || selectedChartCate?.id == 6">
        <div class="sidebar-section">
          <label>Chart Type</label>
          <select [(ngModel)]="selectedChartType" (change)="changeChart()" [compareWith]="compareObjectsByKey('type')">
            <option *ngFor="let f of selectedChartCate?.chartOption" [ngValue]="f">{{ f.name }}</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartType?.xAxis">
          <label>X-Axis</label>
          <select [(ngModel)]="selectedXAxis">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartType?.yAxis">
          <label>Y-Axis</label>
          <select [(ngModel)]="selectedYAxis">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>

        <!-- <label>Aggregation</label>
                <select [(ngModel)]="selectedAgg">
                    <option *ngFor="let func of aggFunctions" [value]="func">{{func | uppercase}}</option>
                </select> -->

        <div class="sidebar-section" *ngIf="selectedChartType?.type === 'pie'">
          <label>Pie Inner Size</label>
          <input type="text" [(ngModel)]="pieInnerSize" placeholder="Please enter 1 to 100 between" />
        </div>
        <div class="sidebar-section" *ngIf="selectedChartType?.type === 'pie'">
          <label>Pie Start Angal</label>
          <input type="number" [(ngModel)]="pieStartAngal" placeholder="Please enter StartAngale" />
        </div>
        <div class="sidebar-section" *ngIf="selectedChartType?.type === 'pie'">
          <label>Pie End Angal</label>
          <input type="number" [(ngModel)]="pieENDAngal" placeholder="Please enter StartAngal" />
        </div>

        <div class="sidebar-section" *ngIf="selectedChartType?.isVisableMatchFeild">
          <label>Match Field</label>
          <select [(ngModel)]="selectedMatchValue">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartType?.thirdArgument">
          <label>Width-Value</label>
          <select [(ngModel)]="selectedThirdArgument">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>


        <!-- // Working on it feature -->
        <!-- <div class="sidebar-section" *ngIf="selectedChartType?.fouthArgument">
                    <label>Inside Name</label>
                    <select [(ngModel)]="selectedForthArgument">
                        <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
                    </select>
                </div> -->

        <div class="sidebar-section" *ngIf="selectedChartType?.stacking">
          <label>Stacked</label>
          <select [(ngModel)]="stacking">
            <option value="">none</option>
            <option value="normal">Normal</option>
            <option value="percent">Percentage</option>
          </select>
        </div>

        <ng-container *ngIf="selectedChartType?.isVisiableSeriesField">
          <div *ngFor="let axis of selectedSeriesFields; let i = index" class="sidebar-section">

            <div class="theme-color-field">
              <label for="themeColorInput">
                Theme color <span class="required">(i.e. #ffffff)<sup>*</sup></span>
              </label>

              <div class="theme-color-input-group">
                <input type="text" id="themeColorInput" [(ngModel)]="axis.color" placeholder="#ffffff"
                  class="theme-color-text" />
                <input type="color" [(ngModel)]="axis.color" class="theme-color-picker" />
              </div>
            </div>

            <label>Select Series Field:</label>
            <select [(ngModel)]="axis.field">
              <option *ngFor="let key of allFields" [value]="key">{{ key }}</option>
            </select>

            <button (click)="removeSeries(i)">‚ùå Remove</button>
          </div>

          <button (click)="addSeries()">‚ûï Add Y-Axis</button>
        </ng-container>

        <div class="sidebar-section" *ngIf="selectedChartType?.zooming">
          <label>Zooming</label>
          <select [(ngModel)]="zooming">
            <option value="">none</option>
            <option value="x">x-axis</option>
            <option value="y">y-axis</option>
            <option value="xy">xy-axis</option>
          </select>
        </div>


        <div class="sidebar-section" *ngIf="selectedChartType?.showLegend">
          <label><input type="checkbox" [(ngModel)]="showLengend" /> Show Lengend</label>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartType?.dataLabel">
          <label><input type="checkbox" [(ngModel)]="dataLabel" /> Show Data Labels</label>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartType?.enableMouseTracking">
          <label><input type="checkbox" [(ngModel)]="enableMouseTracking" /> Enable
            Mouse Tracking</label>
        </div>

      </ng-container>

      <ng-container *ngIf="selectedChartCate?.id == 5">

        <div class="sidebar-section" *ngIf="selectedChartCate?.isVisableMapOption">
          <label>Load Map</label>
          <select [(ngModel)]="selectedMapOption" [compareWith]="compareObjectsByKey('name')">
            <option *ngFor="let f of selectedChartCate.mapOption" [ngValue]="f">{{ f.name }}</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartCate?.isVisableMatchFeild">
          <label>Match Field</label>
          <select [(ngModel)]="selectedMatchValue">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>

        <div class="sidebar-section" *ngIf="selectedChartCate?.xAxis">
          <label>Data Display</label>
          <select [(ngModel)]="selectedXAxis">
            <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
          </select>
        </div>

        <!-- <div class="sidebar-section" *ngIf="selectedChartCate?.yAxis">
                    <label>Y-Axis</label>
                    <select [(ngModel)]="selectedYAxis">
                        <option *ngFor="let f of allFields" [value]="f">{{ f }}</option>
                    </select>
                </div> -->
      </ng-container>

    </aside>

  </div>
  }
</div>

@if (sourceData.length && !addNewSource) {
<div class="sidebar-footer">
  <button class="btn cancel-btn" (click)="onCancel()">‚úñ Cancel</button>
  <button class="btn apply-btn" (click)="onApply()">‚úî Apply</button>
</div>
}
